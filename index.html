<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herhsin | 管理員安全授權系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-green: #39ff14;
            --deep-black: #050507;
            --glass-card-bg: rgba(10, 10, 15, 0.9);
        }

        body {
            background-color: var(--deep-black);
            color: #f0f0f0;
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 50% -20%, rgba(0, 242, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, rgba(0, 242, 255, 0.05) 0%, transparent 30%);
        }

        .tech-font { font-family: 'Orbitron', sans-serif; }

        .highway-lines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.2; pointer-events: none;
        }
        .line {
            position: absolute;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
            height: 1px; width: 300px;
            animation: flow 6s infinite linear;
        }
        @keyframes flow {
            from { transform: translateX(-100vw) translateY(100vh) rotate(-45deg); }
            to { transform: translateX(100vw) translateY(-100vh) rotate(-45deg); }
        }

        .glass-panel {
            background: var(--glass-card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 242, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .nav-btn.active {
            background: rgba(0, 242, 255, 0.1);
            border-left: 4px solid var(--neon-blue);
            color: var(--neon-blue);
        }

        .hud-border { position: relative; }
        .hud-border::before {
            content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px;
            border-top: 2px solid var(--neon-blue); border-left: 2px solid var(--neon-blue);
        }
        .hud-border::after {
            content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px;
            border-bottom: 2px solid var(--neon-blue); border-right: 2px solid var(--neon-blue);
        }

        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.5s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-action {
            background: linear-gradient(135deg, rgba(0,242,255,0.2), rgba(0,242,255,0.05));
            border: 1px solid rgba(0,242,255,0.3);
            transition: 0.3s;
            cursor: pointer;
        }
        .btn-action:hover:not(:disabled) {
            background: var(--neon-blue);
            color: black;
            box-shadow: 0 0 15px var(--neon-blue);
        }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 50;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        .modal.active { display: flex; }

        .status-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        .status-ok { background: rgba(57, 255, 20, 0.1); color: var(--neon-green); border: 1px solid var(--neon-green); }
        .status-warning { background: rgba(255, 215, 0, 0.1); color: gold; border: 1px solid gold; }
        .status-none { background: rgba(255, 0, 0, 0.1); color: #ff4444; border: 1px solid #ff4444; }

        .neon-guardian {
            color: var(--neon-green);
            text-shadow: 0 0 8px var(--neon-green), 0 0 15px rgba(57, 255, 20, 0.5);
            letter-spacing: 4px;
            position: relative;
            background: rgba(57, 255, 20, 0.1);
            padding: 4px 12px;
            border: 1px solid rgba(57, 255, 20, 0.3);
        }

        input[type="date"] { color-scheme: dark; }

        /* 管理員權限控制 CSS */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: block !important; }
        body.is-admin .admin-only-flex { display: flex !important; }
        body.is-admin .admin-only-cell { display: table-cell !important; }
        body.is-admin .admin-hidden { display: none !important; }

        .file-upload-area {
            border: 1px dashed rgba(0, 242, 255, 0.3);
            background: rgba(0, 242, 255, 0.05);
            transition: 0.3s;
        }
        
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--neon-blue);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #error-banner {
            display: none;
            background: rgba(255, 0, 0, 0.15);
            border: 1px solid rgba(255, 0, 0, 0.5);
            color: #ff8888;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 12px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="flex min-h-screen">
    <script>
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyMEoizEmworjcxFkeaSVE9TlFcDK_FZsTmnZAkt4cmGZII4V1uvwy_iGOa2Q2t6X4vzA/exec";
    </script>

    <div class="highway-lines">
        <div class="line" style="top:30%; animation-delay: 0s;"></div>
        <div class="line" style="top:60%; animation-delay: 2s;"></div>
    </div>

    <!-- 左側導航 -->
    <aside class="w-20 md:w-64 glass-panel border-r border-gray-800 flex flex-col z-10 shrink-0">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-cyan-500 shadow-[0_0_10px_#00f2ff] flex items-center justify-center rotate-45">
                <span class="text-black font-black -rotate-45 tech-font text-xs">H</span>
            </div>
            <h1 class="hidden md:block tech-font font-black text-xl tracking-tighter uppercase">HER<span class="text-cyan-400">HSIN</span></h1>
        </div>

        <nav class="flex-1 mt-4 overflow-y-auto">
            <button onclick="showPage('dashboard')" class="nav-btn active w-full p-4 flex items-center gap-4 text-sm font-medium hover:bg-white/5 transition">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2-2v-2z"/></svg>
                <div class="hidden md:flex flex-col items-start leading-tight">
                    <span>車輛總覽</span>
                </div>
            </button>
            <button onclick="showPage('plans')" class="nav-btn w-full p-4 flex items-center gap-4 text-sm font-medium hover:bg-white/5 transition">
                <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <div class="hidden md:flex flex-col items-start leading-tight">
                    <span>保單管理</span>
                </div>
            </button>
        </nav>

        <div class="p-4 border-t border-white/5">
            <div id="admin-status" class="admin-hidden">
                <button onclick="toggleModal('login-modal', true)" class="w-full flex items-center gap-3 p-3 text-xs text-gray-400 hover:text-cyan-400 hover:bg-white/5 transition rounded border border-transparent hover:border-cyan-900">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    <span class="hidden md:inline">管理員登入</span>
                </button>
            </div>
            <div id="admin-logged-in" class="admin-only">
                <div class="flex items-center justify-between p-2 bg-cyan-500/10 rounded border border-cyan-500/30">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-cyan-500 font-bold tech-font">ADMIN</span>
                        <span class="text-[9px] text-cyan-500/70">已授權模式</span>
                    </div>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto min-w-0">
        <!-- 錯誤橫幅 -->
        <div id="error-banner">
            <strong>系統連線異常：</strong> <span id="error-message"></span>
            <br><small>請檢查 Google Apps Script 權限與試算表 ID 是否正確。</small>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div id="page-title-box" class="hud-border p-2 px-4">
                <div class="flex flex-col">
                    <h2 id="page-title-text" class="text-lg font-bold tracking-widest leading-none">車輛總覽</h2>
                    <span class="text-[10px] tech-font text-cyan-500 tracking-tighter mt-1 uppercase">DASHBOARD OVERVIEW</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="fetchFleetData()" id="btn-sync" class="p-2 border border-white/10 hover:border-cyan-500 text-gray-400 hover:text-cyan-500 transition" title="重新整理雲端資料">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357-2H15"/></svg>
                </button>
                <button onclick="openAddVehicleModal()" class="admin-only btn-action px-4 py-2 text-xs font-bold flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                    註冊新車輛
                </button>
                <div class="flex items-center bg-black/40 border border-white/5 overflow-hidden">
                    <div class="neon-guardian text-[10px] font-black tech-font italic border-r border-white/10">極速守護</div>
                    <div id="current-time" class="tech-font text-xs text-cyan-500 px-4 py-2">00:00:00</div>
                </div>
            </div>
        </div>

        <div id="page-dashboard" class="page-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel p-6 hud-border">
                    <p class="text-[10px] text-gray-400 mb-1">車輛總數</p>
                    <h3 id="stat-total" class="text-4xl font-black tech-font text-white">00</h3>
                </div>
                <div class="glass-panel p-6 hud-border">
                    <p class="text-[10px] text-yellow-500 mb-1">即將到期 (30天內)</p>
                    <h3 id="stat-warning" class="text-4xl font-black tech-font text-yellow-500">00</h3>
                </div>
                <div class="glass-panel p-6 hud-border">
                    <p class="text-[10px] text-red-500 mb-1">缺失保單/已過期</p>
                    <h3 id="stat-missing" class="text-4xl font-black tech-font text-red-500">00</h3>
                </div>
            </div>

            <div class="glass-panel overflow-hidden hud-border">
                <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
                    <h4 class="text-xs font-bold tracking-widest text-white/90">全車輛保險狀態儀表板</h4>
                    <span id="sync-status" class="text-[9px] text-gray-500 italic" style="display: none;">正在載入數據...</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-[10px] text-gray-500 border-b border-white/5 bg-black/20">
                            <tr id="fleet-table-header">
                                <th class="p-4">車牌號碼</th>
                                <th class="p-4">車型資訊</th>
                                <th class="p-4">保險公司</th>
                                <th class="p-4">保險狀態</th>
                                <th class="p-4">起始日期</th>
                                <th class="p-4">到期日期</th>
                                <th class="p-4 text-center">文件</th>
                                <th class="p-4 admin-only-cell">操作</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-fleet-list" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-plans" class="page-content space-y-6">
            <div id="plate-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </div>
    </main>

    <!-- 登入視窗 -->
    <div id="login-modal" class="modal">
        <div class="glass-panel w-full max-w-xs p-8 hud-border m-4">
            <div class="text-center mb-6">
                <h3 class="text-lg font-bold text-cyan-400 tech-font">SECURITY GATE</h3>
                <p class="text-[10px] text-gray-500">請輸入管理員金鑰以取得修改權限</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="login-pwd" placeholder="密碼..." class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none text-white text-center">
                <div class="flex gap-2">
                    <button onclick="toggleModal('login-modal', false)" class="flex-1 border border-white/10 py-2 text-xs text-gray-500 hover:text-white transition">取消</button>
                    <button id="btn-login-submit" onclick="handleLogin()" class="flex-1 btn-action py-2 text-xs font-bold text-black uppercase">授權登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 車輛註冊/編輯視窗 -->
    <div id="vehicle-modal" class="modal">
        <div class="glass-panel w-full max-w-md p-8 hud-border m-4 overflow-y-auto max-h-[90vh]">
            <h3 id="modal-title" class="text-lg font-bold mb-6 text-cyan-400 tech-font">SYNC TO CLOUD</h3>
            <form id="vehicle-form" onsubmit="handleVehicleSubmit(event)" class="space-y-5">
                <input type="hidden" id="v-index">
                <input type="hidden" id="v-fileId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">車牌號碼</label>
                        <input type="text" id="v-plate" required placeholder="ABC-1234" class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none tech-font text-white uppercase">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">保險公司</label>
                        <select id="v-company" class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none text-white">
                            <option value="富邦產險">富邦產險</option>
                            <option value="國泰產險">國泰產險</option>
                            <option value="新安東京產險">新安東京產險</option>
                            <option value="新光產險">新光產險</option>
                            <option value="和泰產險">和泰產險</option>
                            <option value="明台產險">明台產險</option>
                            <option value="第一產險">第一產險</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">車型資訊</label>
                    <input type="text" id="v-model" required placeholder="車輛型號..." class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-[10px] text-gray-500 mb-1">起始日</label><input type="date" id="v-start" class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none tech-font text-white"></div>
                    <div><label class="block text-[10px] text-gray-500 mb-1">到期日</label><input type="date" id="v-expiry" class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none tech-font text-white"></div>
                </div>
                
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">保單 PDF 檔案 (雲端儲存)</label>
                    <div class="file-upload-area relative p-6 rounded text-center">
                        <input type="file" id="v-pdf" accept="application/pdf" onchange="handleFileChange(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="file-display" class="space-y-1">
                            <svg class="w-8 h-8 mx-auto text-cyan-500/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            <p class="text-xs text-cyan-400" id="file-name-text">更新或上傳 PDF 到雲端</p>
                        </div>
                    </div>
                    <div id="file-preview-strip" class="hidden mt-2 p-2 bg-cyan-500/10 border border-cyan-500/20 rounded flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-cyan-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-2h2v2zm0-4H9V7h2v5z"/></svg>
                            <span class="text-[10px] text-cyan-400 truncate max-w-[150px]" id="selected-file-name">檔案已選擇</span>
                        </div>
                        <button type="button" onclick="clearFileSelection()" class="text-red-500 hover:text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="toggleModal('vehicle-modal', false)" class="flex-1 border border-white/10 py-3 text-xs text-gray-400">取消</button>
                    <button type="submit" id="btn-save-vehicle" class="flex-1 btn-action py-3 text-xs font-bold text-black uppercase">同步雲端資料庫</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let isAdmin = false;
        let fleetData = [];
        let currentFileBase64 = null;
        let currentFileName = null;
        let isFetching = false;

        window.onload = () => {
            fetchFleetData();
            updateClock();
            setInterval(updateClock, 1000);
            checkAdminSession();
        };

        function hideError() {
            document.getElementById('error-banner').style.display = 'none';
        }

        function showError(msg) {
            document.getElementById('error-banner').style.display = 'block';
            document.getElementById('error-message').textContent = msg;
        }

        async function fetchFleetData() {
            if (isFetching) return;
            isFetching = true;
            hideError();
            // 雖然 display: none，但保留邏輯一致性
            document.getElementById('sync-status').textContent = "正在連線雲端資料庫...";
            
            try {
                const resp = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'fetch' })
                });

                const data = await resp.json();
                
                if (data && data.status === 'error') {
                    throw new Error(data.message || "後端處理異常");
                }

                if (Array.isArray(data)) {
                    fleetData = data;
                    document.getElementById('sync-status').textContent = "數據已同步 (Google Drive)";
                } else {
                    fleetData = [];
                    document.getElementById('sync-status').textContent = "雲端回傳格式不正確";
                }
                
                renderFleet();
            } catch (error) {
                document.getElementById('sync-status').textContent = "同步失敗";
                showError(error.message);
                fleetData = [];
                renderFleet();
            } finally {
                isFetching = false;
            }
        }

        async function handleVehicleSubmit(e) {
            e.preventDefault();
            if (!isAdmin) {
                alert("權限不足：只有管理員可以同步雲端資料。");
                return;
            }

            const btn = document.getElementById('btn-save-vehicle');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> 寫入雲端中...';

            const vehicle = {
                action: 'save',
                plate: document.getElementById('v-plate').value.toUpperCase(),
                model: document.getElementById('v-model').value,
                company: document.getElementById('v-company').value,
                start: document.getElementById('v-start').value || "",
                expiry: document.getElementById('v-expiry').value || "",
                pdfData: currentFileBase64,
                pdfName: currentFileName || "",
                fileId: document.getElementById('v-fileId').value || ""
            };

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(vehicle)
                });
                const res = await response.json();
                
                if (res.status === 'success') {
                    toggleModal('vehicle-modal', false);
                    await fetchFleetData();
                } else {
                    throw new Error(res.message || "儲存失敗");
                }
            } catch (err) {
                alert("存儲失敗：" + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '同步雲端資料庫';
            }
        }

        async function deleteVehicle(index) {
            if (!isAdmin) return;
            const v = fleetData[index];
            if (!v) return;

            if (!confirm(`確定要刪除車輛 ${v.plate} 的紀錄嗎？此動作無法復原。`)) return;

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'delete',
                        plate: v.plate,
                        fileId: v.fileId || ""
                    })
                });
                const res = await response.json();
                if (res.status === 'success') {
                    await fetchFleetData();
                } else {
                    throw new Error(res.message);
                }
            } catch (err) {
                alert("刪除失敗：" + err.message);
            }
        }

        function handleFileChange(input) {
            const file = input.files[0];
            if (file && file.type === "application/pdf") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentFileBase64 = e.target.result;
                    currentFileName = file.name;
                    updateFileUI(file.name);
                };
                reader.readAsDataURL(file);
            }
        }

        function updateFileUI(name) {
            document.getElementById('file-preview-strip').classList.remove('hidden');
            document.getElementById('selected-file-name').textContent = name;
        }

        function clearFileSelection() {
            document.getElementById('v-pdf').value = "";
            document.getElementById('file-preview-strip').classList.add('hidden');
            currentFileBase64 = null;
            currentFileName = null;
        }

        async function handleLogin() {
            const pwdInput = document.getElementById('login-pwd');
            const pwd = pwdInput.value;
            const btn = document.getElementById('btn-login-submit');

            if (!pwd) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> 驗證中...';

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ 
                        action: 'login', 
                        password: pwd 
                    })
                });
                const res = await response.json();

                if (res.status === 'success') {
                    isAdmin = true;
                    sessionStorage.setItem('herhsin_admin', 'true');
                    applyAdminUI();
                    toggleModal('login-modal', false);
                    pwdInput.value = "";
                    renderFleet();
                } else {
                    alert("授權失敗：金鑰錯誤");
                    pwdInput.value = "";
                }
            } catch (err) {
                alert("連線驗證伺服器失敗");
            } finally {
                btn.disabled = false;
                btn.textContent = '授權登入';
            }
        }

        function logout() {
            isAdmin = false;
            sessionStorage.removeItem('herhsin_admin');
            applyAdminUI();
            renderFleet();
        }

        function checkAdminSession() {
            if (sessionStorage.getItem('herhsin_admin') === 'true') {
                isAdmin = true;
                applyAdminUI();
            }
        }

        function applyAdminUI() {
            if (isAdmin) {
                document.body.classList.add('is-admin');
            } else {
                document.body.classList.remove('is-admin');
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            const titleText = pageId === 'dashboard' ? '車輛總覽' : '保單管理';
            document.getElementById('page-title-text').textContent = titleText;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick').includes(pageId)));
        }

        function toggleModal(id, show) {
            const modal = document.getElementById(id);
            if(show) modal.classList.add('active');
            else modal.classList.remove('active');
        }

        function openAddVehicleModal() {
            if (!isAdmin) return;
            document.getElementById('modal-title').textContent = "雲端資產註冊";
            document.getElementById('vehicle-form').reset();
            document.getElementById('v-index').value = "";
            document.getElementById('v-fileId').value = "";
            clearFileSelection();
            toggleModal('vehicle-modal', true);
        }

        function viewPolicy(fileId) {
            if (!fileId) return alert("無檔案紀錄");
            const url = `https://drive.google.com/file/d/${fileId}/view`;
            window.open(url, '_blank');
        }

        function renderFleet() {
            const list = document.getElementById('dashboard-fleet-list');
            const grid = document.getElementById('plate-grid');
            if (!list || !grid) return;

            list.innerHTML = '';
            grid.innerHTML = '';
            
            let warningCount = 0, missingCount = 0;
            const now = new Date();
            const thirtyDays = new Date();
            thirtyDays.setDate(now.getDate() + 30);

            const dataToRender = Array.isArray(fleetData) ? fleetData : [];

            dataToRender.forEach((v, i) => {
                let statusClass = 'status-ok', statusText = '期限內';
                if (!v.expiry) { statusClass = 'status-none'; statusText = '待補齊'; missingCount++; }
                else {
                    const exp = new Date(v.expiry);
                    if (exp < now) { statusClass = 'status-none'; statusText = '已過期'; missingCount++; }
                    else if (exp < thirtyDays) { statusClass = 'status-warning'; statusText = '即將到期'; warningCount++; }
                }

                // 表格列渲染
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition border-b border-white/5";
                
                // 文件內容與操作內容邏輯
                let fileCellContent = isAdmin && v.fileId 
                    ? `<button onclick="viewPolicy('${v.fileId}')" class="text-cyan-500 hover:text-white" title="開啟雲端文件"><svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></button>` 
                    : `<span class="text-gray-800/30"><svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg></span>`;
                
                let actionCell = isAdmin 
                    ? `<td class="p-4 admin-only-cell text-center"><button onclick="deleteVehicle(${i})" class="text-red-500 hover:text-white p-1 transition" title="刪除紀錄"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>` 
                    : '';

                tr.innerHTML = `
                    <td class="p-4 tech-font font-bold text-cyan-400">${v.plate}</td>
                    <td class="p-4 text-gray-400 text-xs">${v.model}</td>
                    <td class="p-4 text-xs font-medium text-white/80">${v.company}</td>
                    <td class="p-4"><span class="status-tag ${statusClass}">${statusText}</span></td>
                    <td class="p-4 text-xs opacity-70">${v.start || '---'}</td>
                    <td class="p-4 tech-font text-xs">${v.expiry || '---'}</td>
                    <td class="p-4 text-center">${fileCellContent}</td>
                    ${actionCell}
                `;
                list.appendChild(tr);

                // 卡片模式渲染 (保單管理頁面)
                const card = document.createElement('div');
                card.className = "glass-panel p-5 plate-card hud-border flex flex-col items-center group";
                
                let cardButton = (isAdmin && v.fileId) 
                    ? `<button onclick="viewPolicy('${v.fileId}')" class="w-full py-2 bg-cyan-500 text-black text-[10px] font-bold uppercase hover:bg-white transition">預覽 Google Drive PDF</button>` 
                    : `<div class="w-full py-2 bg-white/5 text-gray-700 text-[10px] text-center border border-white/5 uppercase">權限限制存取</div>`;

                card.innerHTML = `
                    <div class="w-16 h-20 bg-gradient-to-br from-cyan-500/20 to-transparent border border-cyan-500/30 rounded-lg flex items-center justify-center mb-4 relative overflow-hidden">
                        ${(isAdmin && v.fileId) ? '<div class="absolute inset-0 bg-cyan-500/10"></div>' : ''}
                        <svg class="w-8 h-8 ${(isAdmin && v.fileId) ? 'text-cyan-400' : 'text-gray-800'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    </div>
                    <p class="tech-font text-xl font-black text-white mb-1 group-hover:text-cyan-400 transition">${v.plate}</p>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-4">${v.company}</p>
                    <div class="w-full space-y-2 mt-auto">
                        ${cardButton}
                        <div class="flex justify-between items-center px-1"><span class="text-[9px] text-gray-600 tech-font">EXP: ${v.expiry || '---'}</span><span class="status-tag ${statusClass}" style="padding:1px 4px; font-size:8px;">${statusText}</span></div>
                    </div>
                    ${isAdmin ? `<button onclick="deleteVehicle(${i})" class="mt-4 text-[9px] text-red-500 hover:text-white underline opacity-0 group-hover:opacity-100 transition">刪除雲端紀錄</button>` : ''}
                `;
                grid.appendChild(card);
            });
            
            document.getElementById('stat-total').textContent = dataToRender.length.toString().padStart(2, '0');
            document.getElementById('stat-warning').textContent = warningCount.toString().padStart(2, '0');
            document.getElementById('stat-missing').textContent = missingCount.toString().padStart(2, '0');
        }

        function updateClock() {
            const time = new Date().toLocaleTimeString('zh-TW', {hour12: false});
            const clockEl = document.getElementById('current-time');
            if (clockEl) clockEl.textContent = time;
        }
    </script>
</body>
</html>
