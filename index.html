<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herhsin | 管理員安全授權系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-green: #39ff14;
            --deep-black: #050507;
            --glass-card-bg: rgba(10, 10, 15, 0.9);
        }

        body {
            background-color: var(--deep-black);
            color: #f0f0f0;
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 50% -20%, rgba(0, 242, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, rgba(0, 242, 255, 0.05) 0%, transparent 30%);
        }

        .tech-font { font-family: 'Orbitron', sans-serif; }

        .highway-lines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.2; pointer-events: none;
        }
        .line {
            position: absolute;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
            height: 1px; width: 300px;
            animation: flow 6s infinite linear;
        }
        @keyframes flow {
            from { transform: translateX(-100vw) translateY(100vh) rotate(-45deg); }
            to { transform: translateX(100vw) translateY(-100vh) rotate(-45deg); }
        }

        .glass-panel {
            background: var(--glass-card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 242, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .nav-btn {
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-btn.active {
            background: rgba(0, 242, 255, 0.08);
            border-left: 4px solid var(--neon-blue);
            color: var(--neon-blue);
            box-shadow: inset 10px 0 20px -10px rgba(0, 242, 255, 0.2);
        }

        .nav-btn.active svg {
            filter: drop-shadow(0 0 5px var(--neon-blue));
        }

        .hud-border { position: relative; }
        .hud-border::before {
            content: ''; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px;
            border-top: 2px solid var(--neon-blue); border-left: 2px solid var(--neon-blue);
        }
        .hud-border::after {
            content: ''; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px;
            border-bottom: 2px solid var(--neon-blue); border-right: 2px solid var(--neon-blue);
        }

        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.5s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-action {
            background: linear-gradient(135deg, rgba(0,242,255,0.2), rgba(0,242,255,0.05));
            border: 1px solid rgba(0,242,255,0.3);
            transition: 0.3s;
            cursor: pointer;
        }
        .btn-action:hover:not(:disabled) {
            background: var(--neon-blue);
            color: black;
            box-shadow: 0 0 15px var(--neon-blue);
        }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 50;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        .modal.active { display: flex; }

        .status-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        .status-ok { background: rgba(57, 255, 20, 0.1); color: var(--neon-green); border: 1px solid var(--neon-green); }
        .status-warning { background: rgba(255, 215, 0, 0.1); color: gold; border: 1px solid gold; }
        .status-none { background: rgba(255, 0, 0, 0.1); color: #ff4444; border: 1px solid #ff4444; }

        .neon-guardian {
            color: var(--neon-green);
            text-shadow: 0 0 8px var(--neon-green), 0 0 15px rgba(57, 255, 20, 0.5);
            letter-spacing: 4px;
            position: relative;
            background: rgba(57, 255, 20, 0.1);
            padding: 4px 12px;
            border: 1px solid rgba(57, 255, 20, 0.3);
        }

        input[type="date"] { color-scheme: dark; }

        /* 管理員權限控制 CSS */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: block !important; }
        body.is-admin .admin-only-flex { display: flex !important; }
        body.is-admin .admin-only-cell { display: table-cell !important; }
        body.is-admin .admin-hidden { display: none !important; }

        .file-upload-area {
            border: 1px dashed rgba(0, 242, 255, 0.3);
            background: rgba(0, 242, 255, 0.05);
            transition: 0.3s;
        }
        
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--neon-blue);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #error-banner {
            display: none;
            background: rgba(255, 0, 0, 0.15);
            border: 1px solid rgba(255, 0, 0, 0.5);
            color: #ff8888;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 12px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="flex min-h-screen">
    <script>
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyMEoizEmworjcxFkeaSVE9TlFcDK_FZsTmnZAkt4cmGZII4V1uvwy_iGOa2Q2t6X4vzA/exec";
        
        function getTaiwanDate(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            return new Date(d.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
        }

        function formatToTaiwanString(dateStr) {
            if (!dateStr) return '---';
            const d = new Date(dateStr);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Taipei' };
            const parts = new Intl.DateTimeFormat('zh-TW', options).formatToParts(d);
            const year = parts.find(p => p.type === 'year').value;
            const month = parts.find(p => p.type === 'month').value;
            const day = parts.find(p => p.type === 'day').value;
            return `${year}-${month}-${day}`;
        }

        function openPdf(fileId) {
            if (!fileId) {
                alert("此車輛目前尚未上傳保單 PDF。");
                return;
            }
            window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
        }
    </script>

    <div class="highway-lines">
        <div class="line" style="top:30%; animation-delay: 0s;"></div>
        <div class="line" style="top:60%; animation-delay: 2s;"></div>
    </div>

    <!-- 左側導航 -->
    <aside class="w-20 md:w-64 glass-panel border-r border-gray-800 flex flex-col z-10 shrink-0">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-cyan-500 shadow-[0_0_10px_#00f2ff] flex items-center justify-center rotate-45">
                <span class="text-black font-black -rotate-45 tech-font text-xs">H</span>
            </div>
            <h1 class="hidden md:block tech-font font-black text-xl tracking-tighter uppercase">HER<span class="text-cyan-400">HSIN</span></h1>
        </div>

        <nav class="flex-1 mt-4 overflow-y-auto">
            <button onclick="showPage('dashboard')" class="nav-btn active w-full p-4 flex items-center gap-4 text-sm font-medium hover:bg-white/5 transition">
                <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <div class="hidden md:flex flex-col items-start leading-tight">
                    <span>車輛總覽</span>
                </div>
            </button>
            <button onclick="showPage('plans')" class="nav-btn w-full p-4 flex items-center gap-4 text-sm font-medium hover:bg-white/5 transition">
                <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <div class="hidden md:flex flex-col items-start leading-tight">
                    <span>保單管理</span>
                </div>
            </button>
        </nav>

        <div class="p-4 border-t border-white/5">
            <div id="admin-status" class="admin-hidden">
                <button onclick="toggleModal('login-modal', true)" class="w-full flex items-center gap-3 p-3 text-xs text-gray-400 hover:text-cyan-400 hover:bg-white/5 transition rounded border border-transparent hover:border-cyan-900">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    <span class="hidden md:inline">管理員登入</span>
                </button>
            </div>
            <div id="admin-logged-in" class="admin-only">
                <div class="flex items-center justify-between p-2 bg-cyan-500/10 rounded border border-cyan-500/30">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-cyan-500 font-bold">已授權模式</span>
                    </div>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-500 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto min-w-0">
        <div id="error-banner">
            <strong>系統連線異常：</strong> <span id="error-message"></span>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div id="page-title-box" class="hud-border p-2 px-4">
                <div class="flex flex-col">
                    <h2 id="page-title-text" class="text-lg font-bold tracking-widest leading-none">車輛總覽</h2>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="fetchFleetData()" id="btn-sync" class="p-2 border border-white/10 hover:border-cyan-500 text-gray-400 hover:text-cyan-500 transition" title="重新整理雲端資料">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357-2H15"/></svg>
                </button>
                <button onclick="openAddVehicleModal()" class="admin-only btn-action px-4 py-2 text-xs font-bold flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                    註冊新車輛
                </button>
                <div class="flex items-center bg-black/40 border border-white/5 overflow-hidden">
                    <div class="neon-guardian text-[10px] font-black tech-font italic border-r border-white/10">極速守護</div>
                    <div id="current-time" class="tech-font text-xs text-cyan-500 px-4 py-2">00:00:00</div>
                </div>
            </div>
        </div>

        <!-- 總覽分頁 -->
        <div id="page-dashboard" class="page-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel p-6 hud-border">
                    <p class="text-[10px] text-gray-400 mb-1">車輛總數</p>
                    <h3 id="stat-total" class="text-4xl font-black tech-font text-white">00</h3>
                </div>
                <div class="glass-panel p-6 hud-border">
                    <p class="text-[10px] text-yellow-500 mb-1">即將到期 (30天內)</p>
                    <h3 id="stat-warning" class="text-4xl font-black tech-font text-yellow-500">00</h3>
                </div>
                <div class="glass-panel p-6 hud-border">
                    <p class="text-[10px] text-red-500 mb-1">缺失保單/已過期</p>
                    <h3 id="stat-missing" class="text-4xl font-black tech-font text-red-500">00</h3>
                </div>
            </div>

            <div class="glass-panel overflow-hidden hud-border">
                <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
                    <h4 class="text-xs font-bold tracking-widest text-white/90">全車輛保險狀態儀表板</h4>
                    <span id="sync-status" class="text-[9px] text-gray-500 italic" style="display: none;">正在載入數據...</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-[10px] text-gray-500 border-b border-white/5 bg-black/20">
                            <tr>
                                <th class="p-4">車牌號碼</th>
                                <th class="p-4">車型資訊</th>
                                <th class="p-4">保險公司</th>
                                <th class="p-4">保險狀態</th>
                                <th class="p-4">起始日期</th>
                                <th class="p-4">到期日期</th>
                                <th class="p-4 text-center">編輯</th>
                                <th class="p-4 admin-only-cell text-center">移除</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-fleet-list" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 保單管理分頁 -->
        <div id="page-plans" class="page-content space-y-6">
            <div class="mb-4">
                <p class="text-[10px] text-gray-500 tracking-widest uppercase">已存檔電子保單</p>
            </div>
            <div id="plate-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
        </div>
    </main>

    <!-- 登入視窗 -->
    <div id="login-modal" class="modal">
        <div class="glass-panel w-full max-w-xs p-8 hud-border m-4">
            <div class="text-center mb-6">
                <h3 class="text-lg font-bold text-cyan-400 tech-font">SECURITY GATE</h3>
            </div>
            <div class="space-y-4">
                <input type="password" id="login-pwd" placeholder="密碼..." class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none text-white text-center">
                <div class="flex gap-2">
                    <button onclick="toggleModal('login-modal', false)" class="flex-1 border border-white/10 py-2 text-xs text-gray-500 hover:text-white transition">取消</button>
                    <button id="btn-login-submit" onclick="handleLogin()" class="flex-1 btn-action py-2 text-xs font-bold text-black uppercase">授權登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯/註冊視窗 -->
    <div id="vehicle-modal" class="modal">
        <div class="glass-panel w-full max-w-md p-8 hud-border m-4 overflow-y-auto max-h-[90vh]">
            <h3 id="modal-title" class="text-lg font-bold mb-6 text-cyan-400 tech-font">SYNC TO CLOUD</h3>
            <form id="vehicle-form" onsubmit="handleVehicleSubmit(event)" class="space-y-5">
                <input type="hidden" id="v-index">
                <input type="hidden" id="v-fileId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">車牌號碼</label>
                        <input type="text" id="v-plate" required class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none tech-font text-white uppercase">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">保險公司</label>
                        <select id="v-company" class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none text-white">
                            <option value="富邦產險">富邦產險</option>
                            <option value="國泰產險">國泰產險</option>
                            <option value="新安東京產險">新安東京產險</option>
                            <option value="新光產險">新光產險</option>
                            <option value="和泰產險">和泰產險</option>
                            <option value="明台產險">明台產險</option>
                            <option value="第一產險">第一產險</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">車型資訊</label>
                    <input type="text" id="v-model" required class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-[10px] text-gray-500 mb-1">起始日</label><input type="date" id="v-start" class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none tech-font text-white"></div>
                    <div><label class="block text-[10px] text-gray-500 mb-1">到期日</label><input type="date" id="v-expiry" class="w-full bg-black/50 border border-white/10 p-3 text-sm focus:border-cyan-500 outline-none tech-font text-white"></div>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">保單 PDF 檔案</label>
                    <div class="file-upload-area relative p-6 rounded text-center">
                        <input type="file" id="v-pdf" accept="application/pdf" onchange="handleFileChange(this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="file-display" class="space-y-1">
                            <svg class="w-8 h-8 mx-auto text-cyan-500/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            <p class="text-xs text-cyan-400" id="file-name-text">點擊或拖曳上傳保單</p>
                        </div>
                    </div>
                    <div id="file-preview-strip" class="hidden mt-2 p-2 bg-cyan-500/10 border border-cyan-500/20 rounded flex items-center justify-between">
                        <span class="text-[10px] text-cyan-400 truncate max-w-[150px]" id="selected-file-name">檔案已選擇</span>
                        <button type="button" onclick="clearFileSelection()" class="text-red-500 hover:text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
                    </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="toggleModal('vehicle-modal', false)" class="flex-1 border border-white/10 py-3 text-xs text-gray-400">取消</button>
                    <button type="submit" id="btn-save-vehicle" class="flex-1 btn-action py-3 text-xs font-bold text-black uppercase">同步雲端資料庫</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let isAdmin = false;
        let fleetData = [];
        let currentFileBase64 = null;
        let currentFileName = null;
        let isFetching = false;

        window.onload = () => {
            fetchFleetData();
            updateClock();
            setInterval(updateClock, 1000);
            checkAdminSession();
        };

        function hideError() {
            document.getElementById('error-banner').style.display = 'none';
        }

        function showError(msg) {
            document.getElementById('error-banner').style.display = 'block';
            document.getElementById('error-message').textContent = msg;
        }

        async function fetchFleetData() {
            if (isFetching) return;
            isFetching = true;
            hideError();
            document.getElementById('sync-status').style.display = 'inline';
            document.getElementById('sync-status').textContent = "同步中...";
            
            try {
                const resp = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'fetch' })
                });

                const data = await resp.json();
                if (data && data.status === 'error') throw new Error(data.message);

                fleetData = Array.isArray(data) ? data : [];
                document.getElementById('sync-status').textContent = "已更新";
                renderFleet();
            } catch (error) {
                document.getElementById('sync-status').textContent = "同步失敗";
                showError(error.message);
                renderFleet();
            } finally {
                isFetching = false;
                setTimeout(() => { document.getElementById('sync-status').style.display = 'none'; }, 2000);
            }
        }

        async function handleVehicleSubmit(e) {
            e.preventDefault();
            if (!isAdmin) return;

            const btn = document.getElementById('btn-save-vehicle');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> 同步中...';

            const vehicle = {
                action: 'save',
                plate: document.getElementById('v-plate').value.toUpperCase(),
                model: document.getElementById('v-model').value,
                company: document.getElementById('v-company').value,
                start: document.getElementById('v-start').value || "",
                expiry: document.getElementById('v-expiry').value || "",
                pdfData: currentFileBase64,
                pdfName: currentFileName || "",
                fileId: document.getElementById('v-fileId').value || ""
            };

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(vehicle)
                });
                const res = await response.json();
                if (res.status === 'success') {
                    toggleModal('vehicle-modal', false);
                    await fetchFleetData();
                } else {
                    throw new Error(res.message);
                }
            } catch (err) {
                alert("存儲失敗：" + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '同步雲端資料庫';
            }
        }

        async function deleteVehicle(index) {
            if (!isAdmin) return;
            const v = fleetData[index];
            if (!confirm(`確定要刪除車輛 ${v.plate} 嗎？`)) return;

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'delete', plate: v.plate, fileId: v.fileId || "" })
                });
                const res = await response.json();
                if (res.status === 'success') await fetchFleetData();
            } catch (err) { alert("刪除失敗"); }
        }

        function handleFileChange(input) {
            const file = input.files[0];
            if (file && file.type === "application/pdf") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentFileBase64 = e.target.result;
                    currentFileName = file.name;
                    document.getElementById('file-preview-strip').classList.remove('hidden');
                    document.getElementById('selected-file-name').textContent = file.name;
                };
                reader.readAsDataURL(file);
            }
        }

        function clearFileSelection() {
            document.getElementById('v-pdf').value = "";
            document.getElementById('file-preview-strip').classList.add('hidden');
            currentFileBase64 = null;
            currentFileName = null;
        }

        async function handleLogin() {
            const pwd = document.getElementById('login-pwd').value;
            const btn = document.getElementById('btn-login-submit');
            btn.disabled = true;

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'login', password: pwd })
                });
                const res = await response.json();
                if (res.status === 'success') {
                    isAdmin = true;
                    sessionStorage.setItem('herhsin_admin', 'true');
                    applyAdminUI();
                    toggleModal('login-modal', false);
                    renderFleet();
                } else { alert("金鑰錯誤"); }
            } catch (err) { alert("驗證失敗"); } finally { btn.disabled = false; }
        }

        function logout() {
            isAdmin = false;
            sessionStorage.removeItem('herhsin_admin');
            applyAdminUI();
            renderFleet();
        }

        function applyAdminUI() {
            document.body.classList.toggle('is-admin', isAdmin);
        }

        function checkAdminSession() {
            if (sessionStorage.getItem('herhsin_admin') === 'true') {
                isAdmin = true;
                applyAdminUI();
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.getElementById('page-title-text').textContent = pageId === 'dashboard' ? '車輛總覽' : '保單管理';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.getAttribute('onclick').includes(pageId)));
        }

        function toggleModal(id, show) {
            const modal = document.getElementById(id);
            if(show) modal.classList.add('active');
            else modal.classList.remove('active');
        }

        function openAddVehicleModal() {
            if (!isAdmin) return;
            document.getElementById('modal-title').textContent = "雲端資產註冊";
            document.getElementById('vehicle-form').reset();
            document.getElementById('v-plate').readOnly = false;
            document.getElementById('v-fileId').value = "";
            clearFileSelection();
            toggleModal('vehicle-modal', true);
        }

        function openEditModal(index) {
            if (!isAdmin) return;
            const v = fleetData[index];
            document.getElementById('modal-title').textContent = "編輯車輛資料";
            document.getElementById('v-index').value = index;
            document.getElementById('v-plate').value = v.plate;
            document.getElementById('v-plate').readOnly = true; 
            document.getElementById('v-model').value = v.model || "";
            document.getElementById('v-company').value = v.company || "富邦產險";
            document.getElementById('v-start').value = v.start ? formatToTaiwanString(v.start) : "";
            document.getElementById('v-expiry').value = v.expiry ? formatToTaiwanString(v.expiry) : "";
            document.getElementById('v-fileId').value = v.fileId || "";
            clearFileSelection();
            toggleModal('vehicle-modal', true);
        }

        function renderFleet() {
            const list = document.getElementById('dashboard-fleet-list');
            const grid = document.getElementById('plate-grid');
            list.innerHTML = '';
            grid.innerHTML = '';
            
            let warningCount = 0, missingCount = 0;
            const now = getTaiwanDate(new Date());
            const thirtyDays = new Date(now);
            thirtyDays.setDate(now.getDate() + 30);

            fleetData.forEach((v, i) => {
                let statusClass = 'status-ok', statusText = '期限內';
                const displayStart = v.start ? formatToTaiwanString(v.start) : '---';
                const displayExpiry = v.expiry ? formatToTaiwanString(v.expiry) : '---';

                if (!v.expiry) { statusClass = 'status-none'; statusText = '待補齊'; missingCount++; }
                else {
                    const expDate = getTaiwanDate(v.expiry);
                    if (expDate < now) { statusClass = 'status-none'; statusText = '已過期'; missingCount++; }
                    else if (expDate < thirtyDays) { statusClass = 'status-warning'; statusText = '即將到期'; warningCount++; }
                }

                // 總覽表格列
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition border-b border-white/5";
                
                // 修改處：將操作項目按鈕改為文字「編輯」或「檢視」
                const actionBtn = isAdmin 
                    ? `<button onclick="openEditModal(${i})" class="px-3 py-1 border border-cyan-500/50 text-cyan-400 text-xs hover:bg-cyan-500 hover:text-black transition rounded">編輯</button>`
                    : `<button onclick="openPdf('${v.fileId || ""}')" class="px-3 py-1 border border-gray-600 text-gray-400 text-xs hover:border-cyan-400 hover:text-cyan-400 transition rounded">檢視</button>`;

                tr.innerHTML = `
                    <td class="p-4 tech-font font-bold text-cyan-400">${v.plate}</td>
                    <td class="p-4 text-gray-400 text-xs">${v.model}</td>
                    <td class="p-4 text-xs text-white/80">${v.company}</td>
                    <td class="p-4"><span class="status-tag ${statusClass}">${statusText}</span></td>
                    <td class="p-4 text-xs opacity-70">${displayStart}</td>
                    <td class="p-4 tech-font text-xs">${displayExpiry}</td>
                    <td class="p-4 text-center">${actionBtn}</td>
                    ${isAdmin ? `<td class="p-4 text-center"><button onclick="deleteVehicle(${i})" class="text-red-500/50 hover:text-red-500 transition"><svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></td>` : ''}
                `;
                list.appendChild(tr);

                // 保單管理卡片 (不提供編輯，僅供檢視)
                const card = document.createElement('div');
                card.className = "glass-panel p-5 hud-border flex flex-col items-center group relative overflow-hidden";
                
                const pdfAvailable = !!v.fileId;
                const viewBtnClass = pdfAvailable 
                    ? "bg-cyan-500 text-black hover:bg-white" 
                    : "bg-white/5 text-gray-700 border border-white/5 cursor-not-allowed";

                card.innerHTML = `
                    <div class="w-16 h-20 bg-gradient-to-br ${pdfAvailable ? 'from-cyan-500/20' : 'from-gray-900'} to-transparent border border-white/10 rounded-lg flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 ${pdfAvailable ? 'text-cyan-400' : 'text-gray-800'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    </div>
                    <p class="tech-font text-xl font-black text-white mb-1">${v.plate}</p>
                    <p class="text-[10px] text-gray-500 uppercase mb-4">${v.company || '未知公司'}</p>
                    <div class="w-full space-y-2">
                        <button onclick="openPdf('${v.fileId || ""}')" class="w-full py-2 text-[10px] font-bold uppercase transition ${viewBtnClass}">
                            ${pdfAvailable ? '檢視電子保單' : '保單尚未上傳'}
                        </button>
                        <div class="flex justify-between items-center px-1">
                            <span class="text-[9px] text-gray-600 tech-font">到期: ${displayExpiry}</span>
                            <span class="status-tag ${statusClass}" style="padding:1px 4px; font-size:8px;">${statusText}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            document.getElementById('stat-total').textContent = fleetData.length.toString().padStart(2, '0');
            document.getElementById('stat-warning').textContent = warningCount.toString().padStart(2, '0');
            document.getElementById('stat-missing').textContent = missingCount.toString().padStart(2, '0');
        }

        function updateClock() {
            const time = new Date().toLocaleTimeString('zh-TW', {hour12: false, timeZone: 'Asia/Taipei'});
            const clockEl = document.getElementById('current-time');
            if (clockEl) clockEl.textContent = time;
        }
    </script>
</body>
</html>
